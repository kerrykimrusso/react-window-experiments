<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div id="app"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.0.0-beta.3/babel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.2.0/umd/react-dom.development.js"></script>

    <script type="text/babel">
        class Window extends React.Component {
            window = null;

            getFeatures = () => {
                return Object.entries({
                    menubar: this.props.menubar,
                    location: this.props.location,
                    toolbar: this.props.toolbar,
                    width: this.props.width,
                    height: this.props.height,
                    resizeble: this.props.resizeble,
                }).map(([key, value]) => `${key}=${value}`).join();
            }

            componentDidMount() {
                if(this.window) return this.window.open();

                const { url, name } = this.props;
                const w = window.open(url, name, this.getFeatures());
                const childRoot = w.document.createElement('div');
                w.addEventListener('load', this.load(w, childRoot), { once: true });
                w.addEventListener('beforeunload', this.close, { once: true });
                w.render = (children) => {
                    ReactDOM.render(children, childRoot);
                }
                this.window = w;
            }
            
            componentDidUpdate() {
                if(this.window) {
                    this.window.render(this.props.children(this.window))
                }
            }

            componentWillUnmount() {
                this.window = null;
            }

            load = (window, root) => () => {
                window.document.body.appendChild(root);
                this.forceUpdate();
                if(this.props.onLoad) this.props.onLoad();
            }

            close = () => {
                this.window.close();
                if(this.props.onClose) this.props.onClose();
            }
        
            render() {
                return null;
            }
        }
    
        class App extends React.Component {
            state = {
                openWindow: false,
                message: '',
                counts: [0,0,0],
            }
        
            openNewWindow = () => {
                this.setState({
                    openWindow: true,
                    message: 'You created a child! Parenthood is the greatest...',
                });
            }

            increment = () => {
                const idx = Math.floor(Math.random() * this.state.counts.length)
                const nextCounts= this.state.counts.slice();
                nextCounts[idx] += 1;
                this.setState({counts: nextCounts});
            }
            
            onChildWindowClose = () => {
                this.setState({
                    openWindow: false,
                    message: 'Child closed!'
                });
            }

            render() {
                return (
                    <div>
                    <div>Count: {this.state.counts.join(', ')}</div>
                    <button onClick={this.openNewWindow}>Open!</button>
                    <button onClick={this.increment}>Increment!</button>
                    <div>{this.state.message}</div>
                    {this.state.openWindow && 
                        <Window 
                            url='blank.html'
                            name='child'
                            onClose={this.onChildWindowClose}
                            width={640}
                            height={480}
                            menubar
                            toolbar
                        >
                        {(window) => (
                            <div>
                                <div>Cool stuff</div>
                                <div>More cool stuff</div>
                                <div>Count: {this.state.counts.join(', ')}</div>
                                <button onClick={() => window.close()}>Close!</button>
                                <button onClick={this.increment}>Increment!</button>
                            </div>
                        )}
                        </Window>
                    }
                    </div>
                );
            } 
        }
    
        ReactDOM.render(<App />, document.querySelector('#app'));
    </script>
</body>
</html>
